// jQuery List DragSort v0.5.1
// License: http://dragsort.codeplex.com/license
(function(e){e.fn.dragsort=function(t){if("destroy"!=t){var n=e.extend({},e.fn.dragsort.defaults,t),r=[],i=null,s=null;return this.each(function(t,o){e(o).is("table")&&1==e(o).children().size()&&e(o).children().is("tbody")&&(o=e(o).children().get(0));var u={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:o,init:function(){var r=0==e(this.container).children().size()?"li":e(this.container).children(":first").get(0).tagName.toLowerCase();""==n.itemSelector&&(n.itemSelector=r),""==n.dragSelector&&(n.dragSelector=r),""==n.placeHolderTemplate&&(n.placeHolderTemplate="<"+r+">&nbsp;</"+r+">"),e(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var t=r[e(this).attr("data-listidx")];e(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit"),t.styleDragHandlers(!1)},getItems:function(){return e(this.container).children(n.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return e(this).is(n.dragSelector)?this:e(this).find(n.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){if(!(1!=t.which||e(t.target).is(n.dragSelectorExclude)||0<e(t.target).closest(n.dragSelectorExclude).size()||0==e(t.target).closest(n.itemSelector).size())){t.preventDefault();for(var i=t.target;!e(i).is(n.dragSelector);){if(i==this)return;i=i.parentNode}e(i).attr("data-cursor",e(i).css("cursor")),e(i).css("cursor","move");var s=r[e(this).attr("data-listidx")],o=this,u=function(){s.dragStart.call(o,t),e(s.container).unbind("mousemove",u)};e(s.container).mousemove(u).mouseup(function(){e(s.container).unbind("mousemove",u),e(i).css("cursor",e(i).attr("data-cursor"))})}},dragStart:function(t){null!=i&&null!=i.draggedItem&&i.dropItem(),i=r[e(this).attr("data-listidx")],i.draggedItem=e(t.target).closest(n.itemSelector),i.draggedItem.attr("data-origpos",e(this).attr("data-listidx")+"-"+i.getItems().index(i.draggedItem));var s=parseInt(i.draggedItem.css("marginTop")),o=parseInt(i.draggedItem.css("marginLeft"));i.offset=i.draggedItem.offset(),i.offset.top=t.pageY-i.offset.top+(isNaN(s)?0:s)-1,i.offset.left=t.pageX-i.offset.left+(isNaN(o)?0:o)-1,n.dragBetween||(s=0==e(i.container).outerHeight()?Math.max(1,Math.round(.5+i.getItems().size()*i.draggedItem.outerWidth()/e(i.container).outerWidth()))*i.draggedItem.outerHeight():e(i.container).outerHeight(),i.offsetLimit=e(i.container).offset(),i.offsetLimit.right=i.offsetLimit.left+e(i.container).outerWidth()-i.draggedItem.outerWidth(),i.offsetLimit.bottom=i.offsetLimit.top+s-i.draggedItem.outerHeight()),s=i.draggedItem.height(),o=i.draggedItem.width(),"tr"==n.itemSelector?(i.draggedItem.children().each(function(){e(this).width(e(this).width())}),i.placeHolderItem=i.draggedItem.clone().attr("data-placeholder",!0),i.draggedItem.after(i.placeHolderItem),i.placeHolderItem.children().each(function(){e(this).css({borderWidth:0,width:e(this).width()+1,height:e(this).height()+1}).html("&nbsp;")})):(i.draggedItem.after(n.placeHolderTemplate),i.placeHolderItem=i.draggedItem.next().css({height:s,width:o}).attr("data-placeholder",!0));if("td"==n.itemSelector){var u=i.draggedItem.closest("table").get(0);e("<table id='"+u.id+"' style='border-width: 0px;' class='dragSortItem "+u.className+"'><tr></tr></table>").appendTo("body").children().append(i.draggedItem)}u=i.draggedItem.attr("style"),i.draggedItem.attr("data-origstyle",u?u:""),i.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:s,width:o}),i.scroll={moveX:0,moveY:0,maxX:e(document).width()-e(window).width(),maxY:e(document).height()-e(window).height()},i.scroll.scrollY=window.setInterval(function(){if(n.scrollContainer!=window)e(n.scrollContainer).scrollTop(e(n.scrollContainer).scrollTop()+i.scroll.moveY);else{var t=e(n.scrollContainer).scrollTop();if(0<i.scroll.moveY&&t<i.scroll.maxY||0>i.scroll.moveY&&0<t)e(n.scrollContainer).scrollTop(t+i.scroll.moveY),i.draggedItem.css("top",i.draggedItem.offset().top+i.scroll.moveY+1)}},10),i.scroll.scrollX=window.setInterval(function(){if(n.scrollContainer!=window)e(n.scrollContainer).scrollLeft(e(n.scrollContainer).scrollLeft()+i.scroll.moveX);else{var t=e(n.scrollContainer).scrollLeft();if(0<i.scroll.moveX&&t<i.scroll.maxX||0>i.scroll.moveX&&0<t)e(n.scrollContainer).scrollLeft(t+i.scroll.moveX),i.draggedItem.css("left",i.draggedItem.offset().left+i.scroll.moveX+1)}},10),e(r).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),i.setPos(t.pageX,t.pageY),e(document).bind("mousemove",i.swapItems),e(document).bind("mouseup",i.dropItem),n.scrollContainer!=window&&e(window).bind("DOMMouseScroll mousewheel",i.wheel)},setPos:function(t,r){var s=r-this.offset.top,o=t-this.offset.left;n.dragBetween||(s=Math.min(this.offsetLimit.bottom,Math.max(s,this.offsetLimit.top)),o=Math.min(this.offsetLimit.right,Math.max(o,this.offsetLimit.left))),this.draggedItem.parents().each(function(){if("static"!=e(this).css("position")&&(!e.browser.mozilla||"table"!=e(this).css("display"))){var t=e(this).offset();return s-=t.top,o-=t.left,!1}});if(n.scrollContainer==window)r-=e(window).scrollTop(),t-=e(window).scrollLeft(),r=Math.max(0,r-e(window).height()+5)+Math.min(0,r-5),t=Math.max(0,t-e(window).width()+5)+Math.min(0,t-5);else var u=e(n.scrollContainer),l=u.offset(),r=Math.max(0,r-u.height()-l.top)+Math.min(0,r-l.top),t=Math.max(0,t-u.width()-l.left)+Math.min(0,t-l.left);i.scroll.moveX=0==t?0:t*n.scrollSpeed/Math.abs(t),i.scroll.moveY=0==r?0:r*n.scrollSpeed/Math.abs(r),this.draggedItem.css({top:s,left:o})},wheel:function(t){if((e.browser.safari||e.browser.mozilla)&&i&&n.scrollContainer!=window){var r=e(n.scrollContainer),s=r.offset();t.pageX>s.left&&t.pageX<s.left+r.width()&&t.pageY>s.top&&t.pageY<s.top+r.height()&&(s=t.detail?5*t.detail:t.wheelDelta/-2,r.scrollTop(r.scrollTop()+s),t.preventDefault())}},buildPositionTable:function(){var t=[];this.getItems().not([i.draggedItem[0],i.placeHolderItem[0]]).each(function(n){var r=e(this).offset();r.right=r.left+e(this).outerWidth(),r.bottom=r.top+e(this).outerHeight(),r.elm=this,t[n]=r}),this.pos=t},dropItem:function(){if(null!=i.draggedItem){var t=i.draggedItem.attr("data-origstyle");return i.draggedItem.attr("style",t),""==t&&i.draggedItem.removeAttr("style"),i.draggedItem.removeAttr("data-origstyle"),i.styleDragHandlers(!0),i.placeHolderItem.before(i.draggedItem),i.placeHolderItem.remove(),e("[data-droptarget], .dragSortItem").remove(),window.clearInterval(i.scroll.scrollY),window.clearInterval(i.scroll.scrollX),i.draggedItem.attr("data-origpos")!=e(r).index(i)+"-"+i.getItems().index(i.draggedItem)&&n.dragEnd.apply(i.draggedItem),i.draggedItem.removeAttr("data-origpos"),i.draggedItem=null,e(document).unbind("mousemove",i.swapItems),e(document).unbind("mouseup",i.dropItem),n.scrollContainer!=window&&e(window).unbind("DOMMouseScroll mousewheel",i.wheel),!1}},swapItems:function(t){if(null==i.draggedItem)return!1;i.setPos(t.pageX,t.pageY);for(var o=i.findPos(t.pageX,t.pageY),u=i,c=0;-1==o&&n.dragBetween&&c<r.length;c++)o=r[c].findPos(t.pageX,t.pageY),u=r[c];if(-1==o)return!1;var p=function(){return e(u.container).children().not(u.draggedItem)},t=p().not(n.itemSelector).each(function(){this.idx=p().index(this)});return null==s||s.top>i.draggedItem.offset().top||s.left>i.draggedItem.offset().left?e(u.pos[o].elm).before(i.placeHolderItem):e(u.pos[o].elm).after(i.placeHolderItem),t.each(function(){var t=p().eq(this.idx).get(0);this!=t&&p().index(this)<this.idx?e(this).insertAfter(t):this!=t&&e(this).insertBefore(t)}),e(r).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),s=i.draggedItem.offset(),!1},findPos:function(e,t){for(var n=0;n<this.pos.length;n++)if(this.pos[n].left<e&&this.pos[n].right>e&&this.pos[n].top<t&&this.pos[n].bottom>t)return n;return-1},createDropTargets:function(){n.dragBetween&&e(r).each(function(){var t=e(this.container).find("[data-placeholder]"),r=e(this.container).find("[data-droptarget]");0<t.size()&&0<r.size()?r.remove():0==t.size()&&0==r.size()&&("td"==n.itemSelector?e(n.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):e(this.container).append(i.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),i.placeHolderItem.attr("data-placeholder",!0))})}};u.init(),r.push(u)}),this}e(this.selector).trigger("dragsort-uninit")},e.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery),jQuery(document).ready(function(e){function t(){jQuery("#redux-opts-save-warn").slideDown("slow")}jQuery(".redux-sortable").dragsort({dragSelector:".drag",dragBetween:!1,dragEnd:t})});